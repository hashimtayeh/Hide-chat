<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hide Chat - محادثة خاصة</title>
    <style>
        :root {
            --primary-color: #00ff9f;
            --accent-color: #00ffcc;
            --dark-bg: #0d0d0d;
            --darker-bg: #050505;
            --card-bg: rgba(13, 13, 13, 0.9);
            --text-color: #ffffff;
            --border-color: rgba(0, 255, 159, 0.3);
            --success-color: #00ff9f;
            --error-color: #ff4d4d;
            --warning-color: #ffaa00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--dark-bg), var(--darker-bg));
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo svg {
            width: 50px;
            height: 50px;
        }

        .logo h1 {
            font-size: 24px;
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--error-color);
        }

        .status-dot.connected {
            background: var(--success-color);
            box-shadow: 0 0 10px var(--success-color);
        }

        .status-dot.connecting {
            background: var(--warning-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-id {
            background: rgba(0, 255, 159, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            font-size: 14px;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            min-height: 70vh;
        }

        .sidebar {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0, 255, 159, 0.1);
            display: flex;
            flex-direction: column;
        }

        .chat-area {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0, 255, 159, 0.1);
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--accent-color);
        }

        input, button, select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-color);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 255, 159, 0.2);
        }

        button {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: var(--dark-bg);
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 159, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chat-header {
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            color: var(--primary-color);
        }

        .chat-info {
            font-size: 14px;
            opacity: 0.7;
        }

        .participants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .participant-tag {
            background: rgba(0, 255, 159, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            border: 1px solid var(--border-color);
        }

        .call-controls {
            display: flex;
            gap: 10px;
        }

        .call-btn {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            width: auto;
            padding: 8px 15px;
        }

        .call-btn.active {
            background: var(--primary-color);
            color: var(--dark-bg);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
            max-height: 400px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 12px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: var(--dark-bg);
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 5px;
        }

        .message-info {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }

        .message-input {
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
        }

        .message-input button {
            width: auto;
            padding: 12px 20px;
        }

        .chat-list {
            list-style: none;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            flex: 1;
        }

        .chat-item {
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
        }

        .chat-item:hover {
            background: rgba(0, 255, 159, 0.1);
            border-color: var(--border-color);
        }

        .chat-item.active {
            background: rgba(0, 255, 159, 0.2);
            border-color: var(--primary-color);
        }

        .chat-name {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-preview {
            font-size: 12px;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-top: 5px;
            opacity: 0.6;
        }

        .unread-badge {
            background: var(--primary-color);
            color: var(--dark-bg);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 30px rgba(0, 255, 159, 0.2);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            color: var(--primary-color);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            width: auto;
            padding: 0;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .code-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 24px;
            letter-spacing: 5px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            font-family: monospace;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--card-bg);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1001;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification.error {
            border-left-color: var(--error-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-online {
            background-color: var(--primary-color);
            box-shadow: 0 0 5px var(--primary-color);
        }

        .status-offline {
            background-color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.7;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            font-size: 12px;
            opacity: 0.7;
            gap: 5px;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--primary-color);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            .user-info {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* تأثيرات إضافية */
        .glow-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.1;
        }

        .glow-circle {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
        }

        .glow-1 {
            width: 300px;
            height: 300px;
            background: var(--primary-color);
            top: 10%;
            left: 10%;
        }

        .glow-2 {
            width: 200px;
            height: 200px;
            background: var(--accent-color);
            bottom: 10%;
            right: 10%;
        }
    </style>
</head>
<body>
    <div class="glow-effect">
        <div class="glow-circle glow-1"></div>
        <div class="glow-circle glow-2"></div>
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <svg viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="primaryGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#00ff9f;stop-opacity:1" />
                            <stop offset="30%" style="stop-color:#00e68a;stop-opacity:1" />
                            <stop offset="70%" style="stop-color:#00cc75;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00a85e;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="accentGradient" x1="0%" y1="100%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#00ff9f;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00ffcc;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect x="95" y="120" width="22" height="160" rx="11" ry="11" fill="url(#primaryGradient)"/>
                    <rect x="163" y="120" width="22" height="160" rx="11" ry="11" fill="url(#primaryGradient)"/>
                    <rect x="95" y="191" width="90" height="22" rx="11" ry="11" fill="url(#primaryGradient)"/>
                    <path d="M 215 140
                             A 60 60 0 0 1 275 200
                             A 60 60 0 0 1 215 260"
                          fill="none" 
                          stroke="url(#primaryGradient)" 
                          stroke-width="22" 
                          stroke-linecap="round"/>
                </svg>
                <h1>Hide Chat</h1>
            </div>
            <div class="connection-status">
                <span>الاتصال:</span>
                <div class="status-dot" id="connection-status"></div>
                <span id="connection-text">غير متصل</span>
            </div>
            <div class="user-info">
                <span>معرفك:</span>
                <div class="user-id" id="user-id-display">----</div>
                <button id="new-chat-btn">محادثة جديدة</button>
            </div>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="section-title">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="currentColor"/>
                    </svg>
                    المحادثات
                </div>
                <ul class="chat-list" id="chat-list">
                    </ul>
            </div>

            <div class="chat-area">
                <div class="chat-header">
                    <div>
                        <div class="chat-title" id="current-chat-title">اختر محادثة للبدء</div>
                        <div class="chat-info" id="current-chat-info"></div>
                        <div class="participants-list" id="participants-list"></div>
                    </div>
                    <div class="call-controls" id="call-controls" style="display: none;">
                        <button class="call-btn" id="start-call-btn">بدء مكالمة</button>
                        <button class="call-btn" id="end-call-btn" style="display: none;">إنهاء المكالمة</button>
                    </div>
                </div>
                <div class="messages-container" id="messages-container">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="currentColor"/>
                        </svg>
                        <h3>مرحبًا في Hide Chat</h3>
                        <p>ابدأ محادثة جديدة أو اختر محادثة موجودة للبدء</p>
                    </div>
                </div>
                <div class="message-input" id="message-input" style="display: none;">
                    <input type="text" id="message-text" placeholder="اكتب رسالتك هنا..." maxlength="500">
                    <button id="send-message-btn">إرسال</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="new-chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">بدء محادثة جديدة</h2>
                <button class="close-btn" id="close-modal-btn">&times;</button>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="direct">مباشرة</div>
                <div class="tab" data-tab="group">جماعية</div>
                <div class="tab" data-tab="join">انضمام لجماعية</div>
            </div>
            <div class="tab-content active" id="direct-tab">
                <div class="input-group">
                    <label for="direct-user-id">معرف المستخدم (4 خانات)</label>
                    <input type="text" id="direct-user-id" maxlength="4" placeholder="أدخل المعرف" style="text-transform: uppercase">
                </div>
                <button id="start-direct-chat">بدء المحادثة</button>
            </div>
            <div class="tab-content" id="group-tab">
                <div class="input-group">
                    <label for="group-name">اسم المجموعة (اختياري)</label>
                    <input type="text" id="group-name" placeholder="أدخل اسم المجموعة">
                </div>
                <p style="font-size: 14px; opacity: 0.7; margin: 10px 0;">سيتم إنشاء رمز محادثة جماعية تلقائيًا</p>
                <button id="create-group-chat">إنشاء محادثة جماعية</button>
            </div>
            <div class="tab-content" id="join-tab">
                <div class="input-group">
                    <label for="group-code">رمز المحادثة الجماعية (6 خانات)</label>
                    <input type="text" id="group-code" maxlength="6" placeholder="أدخل الرمز" style="text-transform: uppercase">
                </div>
                <button id="join-group-chat">الانضمام للمحادثة</button>
            </div>
        </div>
    </div>

    <div class="modal" id="group-code-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">رمز المحادثة الجماعية</h2>
                <button class="close-btn" id="close-group-code-btn">&times;</button>
            </div>
            <p>شارك هذا الرمز مع الآخرين للانضمام للمحادثة:</p>
            <div class="code-display" id="group-code-display"></div>
            <button id="copy-group-code">نسخ الرمز</button>
        </div>
    </div>

    <div class="notification" id="notification">
        <div id="notification-text"></div>
    </div>

    <script>
        // بيانات التطبيق
        let currentUser = {
            id: '',
            name: 'مستخدم'
        };

        let chats = [];
        let currentChat = null;
        let socket = null;
        let typingTimeout = null;
        let isConnected = false;

        // ✨ --- جديد: متغيرات المكالمات (WebRTC) --- ✨
        let peerConnection = null;
        let localStream = null;
        let remoteStream = new MediaStream();
        let isCallInProgress = false;
        // خوادم STUN (للمساعدة في اختراق الجدران النارية)
        const STUN_SERVERS = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        // ✨ --- نهاية الإضافة --- ✨


        // خادم WebSocket (يمكن استبداله بخادم حقيقي)
        // ⚠️⚠️⚠️ انتبه: قم بتغيير هذا الرابط إلى رابط خادم Render الخاص بك ⚠️⚠️⚠️
        const WS_SERVER = 'wss://hide-chat.onrender.com'; // للإنتاج
        // const WS_SERVER = 'ws://localhost:10000'; // للاختبار المحلي


        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadChats();
            connectToServer();
        });

        // تهيئة التطبيق
        function initializeApp() {
            // إنشاء معرف المستخدم إذا لم يكن موجودًا
            let userId = sessionStorage.getItem('hideChatUserId');
            if (!userId) {
                userId = generateUserId();
                sessionStorage.setItem('hideChatUserId', userId);
            }
            currentUser.id = userId;
            document.getElementById('user-id-display').textContent = userId;
            
            // إضافة بعض المحادثات الافتراضية للتوضيح
            if (!sessionStorage.getItem('hideChatChats')) {
                createSampleChats();
            }
        }

        // الاتصال بخادم WebSocket
        function connectToServer() {
            updateConnectionStatus('connecting', 'جاري الاتصال...');
            
            try {
                socket = new WebSocket(WS_SERVER);
                
                socket.onopen = function() {
                    isConnected = true;
                    updateConnectionStatus('connected', 'متصل');
                    showNotification('تم الاتصال بالخادم بنجاح', 'success');
                    
                    // إرسال رسالة تعريف المستخدم
                    sendSocketMessage({
                        type: 'user_join',
                        userId: currentUser.id
                    });
                };
                
                socket.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleSocketMessage(message);
                    } catch (e) {
                        console.error('خطأ في معالجة الرسالة:', e);
                    }
                };
                
                socket.onclose = function() {
                    isConnected = false;
                    updateConnectionStatus('disconnected', 'غير متصل');
                    showNotification('تم فصل الاتصال بالخادم', 'error');
                    
                    // محاولة إعادة الاتصال بعد 5 ثواني
                    setTimeout(connectToServer, 5000);
                };
                
                socket.onerror = function(error) {
                    console.error('خطأ في الاتصال:', error);
                    updateConnectionStatus('error', 'خطأ في الاتصال');
                };
                
            } catch (error) {
                console.error('فشل في الاتصال بالخادم:', error);
                updateConnectionStatus('error', 'فشل في الاتصال');
                showNotification('فشل في الاتصال بالخادم', 'error');
            }
        }

        // تحديث حالة الاتصال
        function updateConnectionStatus(status, text) {
            const statusDot = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            statusDot.className = 'status-dot';
            statusText.textContent = text;
            
            switch(status) {
                case 'connected':
                    statusDot.classList.add('connected');
                    break;
                case 'connecting':
                    statusDot.classList.add('connecting');
                    break;
                case 'disconnected':
                case 'error':
                    // الحالة الافتراضية (غير متصل)
                    break;
            }
        }

        // إرسال رسالة عبر WebSocket
        function sendSocketMessage(message) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(message));
                return true;
            } else {
                showNotification('غير متصل بالخادم', 'error');
                return false;
            }
        }

        // معالجة الرسائل الواردة من WebSocket
        function handleSocketMessage(message) {
            // (لمنع تكرار الرسائل من الخادم القديم إذا كان لا يزال يتصل)
            if (message.sender === currentUser.id) return; 

            switch(message.type) {
                case 'user_joined':
                    // (يمكننا تركها فارغة، الخادم يتعامل معها)
                    break;
                    
                case 'user_left':
                    showNotification(`المستخدم ${message.userId} غادر المحادثة`, 'warning');
                    break;
                    
                case 'chat_message':
                    handleIncomingMessage(message);
                    break;
                    
                case 'typing_start':
                    showTypingIndicator(message.userId);
                    break;
                    
                case 'typing_stop':
                    hideTypingIndicator();
                    break;
                    
                // --- ✨ منطق المكالمات الجديد --- ✨
                case 'webrtc_offer':
                    handleOffer(message);
                    break;
                    
                case 'webrtc_answer':
                    handleAnswer(message);
                    break;
                    
                case 'webrtc_ice_candidate':
                    handleICECandidate(message);
                    break;

                case 'call_end':
                    endCall(false); // false = لا ترسل إشعار إنهاء
                    break;
                // --- ✨ نهاية التعديل --- ✨
            }
        }

        // معالجة الرسائل الواردة
        function handleIncomingMessage(message) {
            const { chatId, text, sender, timestamp } = message;
            
            // البحث عن المحادثة
            let chat = chats.find(c => c.id === chatId);
            
            if (!chat) {
                // إنشاء محادثة جديدة إذا لم تكن موجودة
                chat = {
                    id: chatId,
                    type: message.chatType || 'direct',
                    participants: [currentUser.id, sender],
                    messages: [],
                    title: message.chatTitle || `محادثة مع ${sender}`,
                    lastUpdated: Date.now(),
                    unread: 0
                };
                chats.push(chat);
            }
            
            // إضافة الرسالة
            const newMessage = {
                id: 'msg_' + Date.now(),
                text: text,
                sender: sender,
                timestamp: timestamp || new Date().toISOString()
            };
            
            chat.messages.push(newMessage);
            chat.lastUpdated = Date.now();
            
            // زيادة عدد الرسائل غير المقروءة إذا لم تكن المحادثة نشطة
            if (!currentChat || currentChat.id !== chatId) {
                chat.unread = (chat.unread || 0) + 1;
            }
            
            saveChats();
            renderChatList();
            
            // إذا كانت المحادثة الحالية، قم بتحديث الرسائل
            if (currentChat && currentChat.id === chatId) {
                renderMessages();
            } else {
                // إظهار إشعار بالرسالة الجديدة
                showNotification(`رسالة جديدة من ${sender}: ${text}`, 'success');
            }
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // أزرار المحادثة الجديدة
            document.getElementById('new-chat-btn').addEventListener('click', showNewChatModal);
            document.getElementById('close-modal-btn').addEventListener('click', hideNewChatModal);
            document.getElementById('close-group-code-btn').addEventListener('click', hideGroupCodeModal);

            // تبويبات النافذة المنبثقة
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // إزالة النشاط من جميع التبويبات
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    // إضافة النشاط للتبويب المحدد
                    this.classList.add('active');
                    
                    // إخفاء جميع محتويات التبويبات
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // إظهار محتوى التبويب المحدد
                    const tabId = this.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // بدء المحادثات
            document.getElementById('start-direct-chat').addEventListener('click', startDirectChat);
            document.getElementById('create-group-chat').addEventListener('click', createGroupChat);
            document.getElementById('join-group-chat').addEventListener('click', joinGroupChat);
            document.getElementById('copy-group-code').addEventListener('click', copyGroupCode);

            // إرسال الرسائل
            document.getElementById('send-message-btn').addEventListener('click', sendMessage);
            document.getElementById('message-text').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // إرسال إشارة الكتابة
            document.getElementById('message-text').addEventListener('input', function() {
                if (currentChat) {
                    sendTypingIndicator(true);
                }
            });

            // عناصر التحكم بالمكالمة
            document.getElementById('start-call-btn').addEventListener('click', startCall);
            document.getElementById('end-call-btn').addEventListener('click', endCall);
        }

        // توليد معرف مستخدم عشوائي مكون من 4 خانات
        function generateUserId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // توليد رمز محادثة جماعية عشوائي مكون من 6 خانات
        function generateGroupCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // إنشاء محادثات عينة للتوضيح
        function createSampleChats() {
            // لا ننشئ محادثات عينة في النسخة الحقيقية
            chats = [];
            saveChats();
        }

        // إرسال إشارة الكتابة
        function sendTypingIndicator(isTyping) {
            if (!currentChat || !isConnected) return;
            
            clearTimeout(typingTimeout);
            
            if (isTyping) {
                sendSocketMessage({
                    type: 'typing_start',
                    chatId: currentChat.id,
                    userId: currentUser.id
                });
                
                typingTimeout = setTimeout(() => {
                    sendSocketMessage({
                        type: 'typing_stop',
                        chatId: currentChat.id,
                        userId: currentUser.id
                    });
                }, 3000);
            } else {
                sendSocketMessage({
                    type: 'typing_stop',
                    chatId: currentChat.id,
                    userId: currentUser.id
                });
            }
        }

        // عرض مؤشر الكتابة
        function showTypingIndicator(userId) {
            if (!currentChat) return;
            
            let typingIndicator = document.getElementById('typing-indicator');
            if (!typingIndicator) {
                typingIndicator = document.createElement('div');
                typingIndicator.id = 'typing-indicator';
                typingIndicator.className = 'typing-indicator';
                typingIndicator.innerHTML = `
                    <span>${userId} يكتب</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
                document.getElementById('messages-container').appendChild(typingIndicator);
                document.getElementById('messages-container').scrollTop = document.getElementById('messages-container').scrollHeight;
            }
        }

        // إخفاء مؤشر الكتابة
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // عرض نافذة المحادثة الجديدة
        function showNewChatModal() {
            document.getElementById('new-chat-modal').style.display = 'flex';
        }

        // إخفاء نافذة المحادثة الجديدة
        function hideNewChatModal() {
            document.getElementById('new-chat-modal').style.display = 'none';
        }

        // عرض نافذة رمز المحادثة الجماعية
        function showGroupCodeModal(code) {
            document.getElementById('group-code-display').textContent = code;
            document.getElementById('group-code-modal').style.display = 'flex';
        }

        // إخفاء نافذة رمز المحادثة الجماعية
        function hideGroupCodeModal() {
            document.getElementById('group-code-modal').style.display = 'none';
        }

        // ✨ --- بدء محادثة مباشرة (تم التعديل) --- ✨
        function startDirectChat() {
            const userId = document.getElementById('direct-user-id').value.trim().toUpperCase();
            
            if (userId.length !== 4) {
                showNotification('يجب أن يكون المعرف مكون من 4 خانات', 'error');
                return;
            }
            
            if (userId === currentUser.id) {
                showNotification('لا يمكن بدء محادثة مع نفسك', 'error');
                return;
            }

            // ---  ✨ هذا هو الإصلاح ✨ ---
            // إنشاء معرف محادثة ثابت ومحدد بناءً على المستخدمين
            // نقوم بفرز المعرفات أبجديًا لضمان حصول كلا الطرفين على نفس المعرف
            const participants = [currentUser.id, userId].sort();
            const chatId = `direct_${participants[0]}-${participants[1]}`;
            // ---  ✨ نهاية الإصلاح ✨ ---
            
            // التحقق من وجود محادثة مع هذا المستخدم مسبقًا
            // (تم تحديث هذا السطر ليستخدم المعرف الجديد)
            const existingChat = chats.find(chat => chat.id === chatId); 
            
            if (existingChat) {
                switchToChat(existingChat.id);
                hideNewChatModal();
                return;
            }
            
            // إنشاء محادثة جديدة
            // const chatId = 'direct_' + Date.now(); // (تم حذف السطر القديم)
            const newChat = {
                id: chatId, // <--- نستخدم المعرف الجديد المشترك
                type: 'direct',
                participants: [currentUser.id, userId],
                messages: [],
                title: `محادثة مع ${userId}`,
                lastUpdated: Date.now(),
                unread: 0
            };
            
            chats.push(newChat);
            saveChats();
            renderChatList();
            switchToChat(chatId); // <-- هذا سيقوم بإرسال "join_chat" تلقائياً
            hideNewChatModal();
            
            document.getElementById('direct-user-id').value = '';
            showNotification(`تم بدء محادثة مع ${userId}`, 'success');
        }

        // إنشاء محادثة جماعية
        function createGroupChat() {
            const groupCode = generateGroupCode();
            const groupName = document.getElementById('group-name').value.trim();
            const chatId = 'group_' + Date.now();
            
            const newChat = {
                id: chatId,
                type: 'group',
                code: groupCode,
                participants: [currentUser.id],
                messages: [],
                title: groupName || `المحادثة الجماعية ${groupCode}`,
                lastUpdated: Date.now(),
                unread: 0
            };
            
            chats.push(newChat);
            saveChats();
            renderChatList();
            switchToChat(chatId); // <-- ✨ إصلاح: الانضمام فوراً بعد الإنشاء
            hideNewChatModal();
            showGroupCodeModal(groupCode);
            showNotification(`تم إنشاء محادثة جماعية برمز ${groupCode}`, 'success');
            
            document.getElementById('group-name').value = '';
        }

        // الانضمام لمحادثة جماعية
        function joinGroupChat() {
            const groupCode = document.getElementById('group-code').value.trim().toUpperCase();
            
            if (groupCode.length !== 6) {
                showNotification('يجب أن يكون الرمز مكون من 6 خانات', 'error');
                return;
            }
            
            // في التطبيق الحقيقي، هنا سنتحقق من الخادم إذا كانت المجموعة موجودة
            // للتبسيط، سننشئ محادثة جديدة بنفس الرمز
            
            const chatId = 'group_' + groupCode;
            const existingChat = chats.find(chat => chat.id === chatId);
            
            if (existingChat) {
                if (existingChat.participants.includes(currentUser.id)) {
                    switchToChat(existingChat.id);
                    hideNewChatModal();
                    return;
                }
                
                // الانضمام للمحادثة الموجودة
                existingChat.participants.push(currentUser.id);
                existingChat.lastUpdated = Date.now();
            } else {
                // إنشاء محادثة جديدة
                const newChat = {
                    id: chatId,
                    type: 'group',
                    code: groupCode,
                    participants: [currentUser.id],
                    messages: [],
                    title: `المحادثة الجماعية ${groupCode}`,
                    lastUpdated: Date.now(),
                    unread: 0
                };
                chats.push(newChat);
            }
            
            saveChats();
            renderChatList();
            switchToChat(chatId); // <-- الانضمام فوراً
            hideNewChatModal();
            
            document.getElementById('group-code').value = '';
            showNotification(`تم الانضمام للمحادثة الجماعية ${groupCode}`, 'success');
        }

        // نسخ رمز المحادثة الجماعية
        function copyGroupCode() {
            const code = document.getElementById('group-code-display').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showNotification('تم نسخ الرمز', 'success');
            });
        }

        // تحميل المحادثات من التخزين
        function loadChats() {
            const savedChats = sessionStorage.getItem('hideChatChats');
            if (savedChats) {
                chats = JSON.parse(savedChats);
                renderChatList();
            }
        }

        // حفظ المحادثات في التخزين
        function saveChats() {
            sessionStorage.setItem('hideChatChats', JSON.stringify(chats));
        }

        // عرض قائمة المحادثات
        function renderChatList() {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';
            
            if (chats.length === 0) {
                chatList.innerHTML = '<div class="empty-state"><p>لا توجد محادثات بعد</p></div>';
                return;
            }
            
            // ترتيب المحادثات حسب آخر تحديث
            chats.sort((a, b) => (b.lastUpdated || 0) - (a.lastUpdated || 0));
            
            chats.forEach(chat => {
                const lastMessage = chat.messages.length > 0 
                    ? chat.messages[chat.messages.length - 1] 
                    : { text: 'لا توجد رسائل بعد', sender: '', timestamp: new Date().toISOString() };
                
                const chatItem = document.createElement('li');
                chatItem.className = 'chat-item';
                if (currentChat && currentChat.id === chat.id) {
                    chatItem.classList.add('active');
                }
                
                // عرض عدد المشاركين في المحادثات الجماعية
                const participantsText = chat.type === 'group' 
                    ? `${chat.participants.length} مشارك` 
                    : '';
                
                chatItem.innerHTML = `
                    <div class="chat-name">
                        <span class="status-indicator ${isConnected ? 'status-online' : 'status-offline'}"></span>
                        ${chat.title}
                        ${chat.unread > 0 ? `<span class="unread-badge">${chat.unread}</span>` : ''}
                    </div>
                    <div class="chat-preview">${lastMessage.sender ? `${lastMessage.sender === currentUser.id ? 'أنت' : lastMessage.sender}: ` : ''}${lastMessage.text}</div>
                    <div class="chat-meta">
                        <span>${formatTime(lastMessage.timestamp)}</span>
                        <span>${participantsText}</span>
                    </div>
                `;
                
                chatItem.addEventListener('click', () => switchToChat(chat.id));
                chatList.appendChild(chatItem);
            });
        }

        // ✨ --- التبديل إلى محادثة (تم التعديل) --- ✨
        function switchToChat(chatId) {
            currentChat = chats.find(chat => chat.id === chatId);
            if (!currentChat) return;
            
            // ---  ✨ هذا هو الإصلاح ✨ ---
            // أخبر الخادم أننا أصبحنا نشطين في هذه الغرفة
            sendSocketMessage({
                type: 'join_chat',
                chatId: currentChat.id,
                userId: currentUser.id
            });
            // ---  ✨ نهاية الإصلاح ✨ ---

            // إعادة تعيين الرسائل غير المقروءة
            currentChat.unread = 0;
            saveChats();
            
            // تحديث واجهة المحادثة
            document.getElementById('current-chat-title').textContent = currentChat.title;
            
            // عرض معلومات المحادثة
            let chatInfo = '';
            if (currentChat.type === 'direct') {
                const otherParticipant = currentChat.participants.find(p => p !== currentUser.id);
                chatInfo = `محادثة مباشرة مع ${otherParticipant}`;
            } else {
                chatInfo = `${currentChat.participants.length} مشارك - الرمز: ${currentChat.code}`;
            }
            document.getElementById('current-chat-info').textContent = chatInfo;
            
            // عرض قائمة المشاركين
            const participantsList = document.getElementById('participants-list');
            participantsList.innerHTML = '';
            currentChat.participants.forEach(participant => {
                const tag = document.createElement('span');
                tag.className = 'participant-tag';
                tag.textContent = participant;
                participantsList.appendChild(tag);
            });
            
            document.getElementById('message-input').style.display = 'flex';
            document.getElementById('messages-container').innerHTML = '';
            
            // عرض عناصر التحكم بالمكالمة للمحادثات المباشرة فقط
            if (currentChat.type === 'direct') {
                document.getElementById('call-controls').style.display = 'flex';
            } else {
                document.getElementById('call-controls').style.display = 'none';
            }
            
            // عرض الرسائل
            renderMessages();
            
            // تحديث قائمة المحادثات
            renderChatList();
            
            // التركيز على حقل الإدخال
            document.getElementById('message-text').focus();
        }

        // عرض الرسائل في المحادثة الحالية
        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            if (!currentChat || currentChat.messages.length === 0) {
                messagesContainer.innerHTML = '<div class="empty-state"><p>لا توجد رسائل بعد. ابدأ المحادثة الآن!</p></div>';
                return;
            }
            
            // ترتيب الرسائل حسب الوقت
            const sortedMessages = [...currentChat.messages].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            sortedMessages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender === currentUser.id ? 'sent' : 'received'}`;
                
                const messageInfo = document.createElement('div');
                messageInfo.className = 'message-info';
                messageInfo.innerHTML = `
                    <span>${message.sender === currentUser.id ? 'أنت' : message.sender}</span>
                    <span>${formatTime(message.timestamp)}</span>
                `;
                
                messageDiv.textContent = message.text;
                messageDiv.appendChild(messageInfo);
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // التمرير لأسفل لرؤية أحدث الرسائل
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // إرسال رسالة
        function sendMessage() {
            const messageText = document.getElementById('message-text').value.trim();
            if (!messageText || !currentChat || !isConnected) return;
            
            // إرسال الرسالة عبر WebSocket
            const messageData = {
                type: 'chat_message',
                chatId: currentChat.id,
                text: messageText,
                sender: currentUser.id,
                timestamp: new Date().toISOString(),
                chatType: currentChat.type,
                chatTitle: currentChat.title
            };
            
            if (sendSocketMessage(messageData)) {
                // إضافة الرسالة محليًا
                const newMessage = {
                    id: 'msg_' + Date.now(),
                    text: messageText,
                    sender: currentUser.id,
                    timestamp: new Date().toISOString()
                };
                
                currentChat.messages.push(newMessage);
                currentChat.lastUpdated = Date.now();
                saveChats();
                renderMessages();
                renderChatList();
                
                // مسح حقل الإدخال
                document.getElementById('message-text').value = '';
                
                // إخفاء مؤشر الكتابة
                hideTypingIndicator();
                sendTypingIndicator(false);
                
                // إظهار تأكيد الإرسال
                // showNotification('تم إرسال الرسالة', 'success'); // (اختياري: يمكن إلغاء تفعيله لتقليل الإزعاج)
            }
        }

        // تنسيق الوقت
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return 'الآن';
            } else if (diffMins < 60) {
                return `منذ ${diffMins} دقيقة`;
            } else if (diffHours < 24) {
                return `منذ ${diffHours} ساعة`;
            } else if (diffDays < 7) {
                return `منذ ${diffDays} يوم`;
            } else {
                return date.toLocaleDateString('ar-EG');
            }
        }

        // ✨ --- مجموعة دوال المكالمات الجديدة (تم استبدال الدوال القديمة) --- ✨

        // (دالة مساعدة لإعداد الاتصال)
        async function setupPeerConnection(otherUserId) {
            peerConnection = new RTCPeerConnection(STUN_SERVERS);

            // إضافة مسار الصوت المحلي للاتصال
            if (!localStream) {
                 localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            }
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // (إعداد عنصر صوت لتشغيل صوت الطرف الآخر)
            let remoteAudio = document.getElementById('remote-audio');
            if (!remoteAudio) {
                remoteAudio = document.createElement('audio');
                remoteAudio.id = 'remote-audio';
                remoteAudio.autoplay = true;
                document.body.appendChild(remoteAudio);
            }
            
            // عندما يأتي مسار الصوت من الطرف الآخر
            peerConnection.ontrack = (event) => {
                event.streams[0].getTracks().forEach(track => {
                    remoteStream.addTrack(track);
                });
                remoteAudio.srcObject = remoteStream;
            };

            // عندما ينشئ المتصفح "مرشح" (طريق للاتصال)
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    sendSocketMessage({
                        type: 'webrtc_ice_candidate',
                        to: otherUserId,
                        from: currentUser.id,
                        chatId: currentChat.id,
                        candidate: event.candidate
                    });
                }
            };
        }

        // 1. بدء المكالمة (إنشاء العرض)
        async function startCall() {
            if (!currentChat || currentChat.type !== 'direct') return;
            const otherUserId = currentChat.participants.find(p => p !== currentUser.id);

            try {
                await setupPeerConnection(otherUserId);
                
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                sendSocketMessage({
                    type: 'webrtc_offer',
                    to: otherUserId,
                    from: currentUser.id,
                    chatId: currentChat.id,
                    offer: offer
                });

                showNotification('جاري طلب المكالمة...', 'success');
                document.getElementById('start-call-btn').style.display = 'none';
                document.getElementById('end-call-btn').style.display = 'inline-block';
                isCallInProgress = true;

            } catch (err) {
                console.error('Error starting call:', err);
                showNotification('فشل بدء المكالمة. تأكد من إذن الميكروفون.', 'error');
            }
        }

        // 2. معالجة العرض (الطرف المتلقي)
        async function handleOffer(message) {
            if (isCallInProgress) return; // تجاهل إذا كان في مكالمة

            const confirmCall = confirm(`المستخدم ${message.from} يتصل بك. هل تقبل؟`);
            if (!confirmCall) {
                // (يمكن إرسال رسالة رفض)
                return;
            }

            try {
                await setupPeerConnection(message.from);
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                sendSocketMessage({
                    type: 'webrtc_answer',
                    to: message.from,
                    from: currentUser.id,
                    chatId: message.chatId,
                    answer: answer
                });

                showNotification('تم قبول المكالمة', 'success');
                document.getElementById('start-call-btn').style.display = 'none';
                document.getElementById('end-call-btn').style.display = 'inline-block';
                isCallInProgress = true;

            } catch (err) {
                console.error('Error handling offer:', err);
            }
        }

        // 3. معالجة الرد (الطرف البادئ)
        async function handleAnswer(message) {
            if (peerConnection && !peerConnection.currentRemoteDescription) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                showNotification('تم الرد على المكالمة، المكالمة جارية.', 'success');
            }
        }

        // 4. معالجة مرشحات ICE (كلا الطرفين)
        async function handleICECandidate(message) {
            if (peerConnection && message.candidate) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                } catch (err) {
                    console.error('Error adding ICE candidate:', err);
                }
            }
        }

        // 5. إنهاء المكالمة
        function endCall(notifyServer = true) {
            if (isCallInProgress && notifyServer && currentChat) {
                const otherUserId = currentChat.participants.find(p => p !== currentUser.id);
                sendSocketMessage({
                    type: 'call_end',
                    to: otherUserId,
                    from: currentUser.id,
                    chatId: currentChat.id
                });
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = new MediaStream(); // إعادة تعيين
            }
            
            let remoteAudio = document.getElementById('remote-audio');
            if (remoteAudio) {
                remoteAudio.srcObject = null;
            }

            showNotification('تم إنهاء المكالمة', 'success');
            document.getElementById('start-call-btn').style.display = 'inline-block';
            document.getElementById('end-call-btn').style.display = 'none';
            isCallInProgress = false;
        }
        // ✨ --- نهاية مجموعة دوال المكالمات --- ✨


        // عرض الإشعارات
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
