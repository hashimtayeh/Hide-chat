<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hide Chat - محادثة خاصة</title>
    <style>
        :root {
            --primary-color: #00ff9f;
            --accent-color: #00ffcc;
            --dark-bg: #0d0d0d;
            --darker-bg: #050505;
            --card-bg: rgba(13, 13, 13, 0.8);
            --text-color: #ffffff;
            --border-color: rgba(0, 255, 159, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--dark-bg), var(--darker-bg));
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo svg {
            width: 50px;
            height: 50px;
        }

        .logo h1 {
            font-size: 24px;
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-id {
            background: rgba(0, 255, 159, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            min-height: 70vh;
        }

        .sidebar {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0, 255, 159, 0.1);
        }

        .chat-area {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0, 255, 159, 0.1);
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title svg {
            width: 20px;
            height: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--accent-color);
        }

        input, button {
            width: 100%;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-color);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 255, 159, 0.2);
        }

        button {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: var(--dark-bg);
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 159, 0.3);
        }

        .chat-header {
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            color: var(--primary-color);
        }

        .call-controls {
            display: flex;
            gap: 10px;
        }

        .call-btn {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            width: auto;
            padding: 8px 15px;
        }

        .call-btn.active {
            background: var(--primary-color);
            color: var(--dark-bg);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        .message {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.sent {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: var(--dark-bg);
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 0;
        }

        .message-info {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .message-input {
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
        }

        .message-input button {
            width: auto;
            padding: 10px 20px;
        }

        .chat-list {
            list-style: none;
            margin-top: 15px;
        }

        .chat-item {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .chat-item:hover {
            background: rgba(0, 255, 159, 0.1);
            border-color: var(--border-color);
        }

        .chat-item.active {
            background: rgba(0, 255, 159, 0.2);
            border-color: var(--primary-color);
        }

        .chat-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .chat-preview {
            font-size: 12px;
            opacity: 0.7;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 30px rgba(0, 255, 159, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            color: var(--primary-color);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            width: auto;
            padding: 0;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .code-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 24px;
            letter-spacing: 5px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--card-bg);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* تأثيرات إضافية */
        .glow-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.1;
        }

        .glow-circle {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
        }

        .glow-1 {
            width: 300px;
            height: 300px;
            background: var(--primary-color);
            top: 10%;
            left: 10%;
        }

        .glow-2 {
            width: 200px;
            height: 200px;
            background: var(--accent-color);
            bottom: 10%;
            right: 10%;
        }
    </style>
</head>
<body>
    <!-- تأثيرات الخلفية -->
    <div class="glow-effect">
        <div class="glow-circle glow-1"></div>
        <div class="glow-circle glow-2"></div>
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <!-- شعار HC -->
                <svg viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="primaryGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#00ff9f;stop-opacity:1" />
                            <stop offset="30%" style="stop-color:#00e68a;stop-opacity:1" />
                            <stop offset="70%" style="stop-color:#00cc75;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00a85e;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="accentGradient" x1="0%" y1="100%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#00ff9f;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00ffcc;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <!-- حرف H -->
                    <rect x="95" y="120" width="22" height="160" rx="11" ry="11" fill="url(#primaryGradient)"/>
                    <rect x="163" y="120" width="22" height="160" rx="11" ry="11" fill="url(#primaryGradient)"/>
                    <rect x="95" y="191" width="90" height="22" rx="11" ry="11" fill="url(#primaryGradient)"/>
                    <!-- حرف C -->
                    <path d="M 215 140
                             A 60 60 0 0 1 275 200
                             A 60 60 0 0 1 215 260"
                          fill="none" 
                          stroke="url(#primaryGradient)" 
                          stroke-width="22" 
                          stroke-linecap="round"/>
                </svg>
                <h1>Hide Chat</h1>
            </div>
            <div class="user-info">
                <span>معرفك:</span>
                <div class="user-id" id="user-id-display">----</div>
                <button id="new-chat-btn">محادثة جديدة</button>
            </div>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="section-title">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="currentColor"/>
                    </svg>
                    المحادثات
                </div>
                <ul class="chat-list" id="chat-list">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </ul>
            </div>

            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-title" id="current-chat-title">اختر محادثة للبدء</div>
                    <div class="call-controls" id="call-controls" style="display: none;">
                        <button class="call-btn" id="start-call-btn">بدء مكالمة</button>
                        <button class="call-btn" id="end-call-btn" style="display: none;">إنهاء المكالمة</button>
                    </div>
                </div>
                <div class="messages-container" id="messages-container">
                    <!-- الرسائل ستظهر هنا -->
                    <div class="welcome-message" style="text-align: center; padding: 40px 20px; opacity: 0.7;">
                        <h3>مرحبًا في Hide Chat</h3>
                        <p>ابدأ محادثة جديدة أو اختر محادثة موجودة للبدء</p>
                    </div>
                </div>
                <div class="message-input" id="message-input" style="display: none;">
                    <input type="text" id="message-text" placeholder="اكتب رسالتك هنا...">
                    <button id="send-message-btn">إرسال</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إنشاء محادثة جديدة -->
    <div class="modal" id="new-chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">بدء محادثة جديدة</h2>
                <button class="close-btn" id="close-modal-btn">&times;</button>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="direct">مباشرة</div>
                <div class="tab" data-tab="group">جماعية</div>
                <div class="tab" data-tab="join">انضمام لجماعية</div>
            </div>
            <div class="tab-content active" id="direct-tab">
                <div class="input-group">
                    <label for="direct-user-id">معرف المستخدم (4 خانات)</label>
                    <input type="text" id="direct-user-id" maxlength="4" placeholder="أدخل المعرف">
                </div>
                <button id="start-direct-chat">بدء المحادثة</button>
            </div>
            <div class="tab-content" id="group-tab">
                <p>أنشئ محادثة جماعية وشارك الرمز مع الآخرين</p>
                <button id="create-group-chat">إنشاء محادثة جماعية</button>
            </div>
            <div class="tab-content" id="join-tab">
                <div class="input-group">
                    <label for="group-code">رمز المحادثة الجماعية (6 خانات)</label>
                    <input type="text" id="group-code" maxlength="6" placeholder="أدخل الرمز">
                </div>
                <button id="join-group-chat">الانضمام للمحادثة</button>
            </div>
        </div>
    </div>

    <!-- نافذة عرض رمز المحادثة الجماعية -->
    <div class="modal" id="group-code-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">رمز المحادثة الجماعية</h2>
                <button class="close-btn" id="close-group-code-btn">&times;</button>
            </div>
            <p>شارك هذا الرمز مع الآخرين للانضمام للمحادثة:</p>
            <div class="code-display" id="group-code-display"></div>
            <button id="copy-group-code">نسخ الرمز</button>
        </div>
    </div>

    <!-- إشعارات -->
    <div class="notification" id="notification">
        <div id="notification-text"></div>
    </div>

    <script>
        // بيانات التطبيق
        let currentUser = {
            id: '',
            name: 'مستخدم'
        };

        let chats = [];
        let currentChat = null;
        let peerConnection = null;
        let localStream = null;
        let remoteStream = null;

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadChats();
        });

        // تهيئة التطبيق
        function initializeApp() {
            // إنشاء معرف المستخدم إذا لم يكن موجودًا
            let userId = sessionStorage.getItem('hideChatUserId');
            if (!userId) {
                userId = generateUserId();
                sessionStorage.setItem('hideChatUserId', userId);
            }
            currentUser.id = userId;
            document.getElementById('user-id-display').textContent = userId;
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // أزرار المحادثة الجديدة
            document.getElementById('new-chat-btn').addEventListener('click', showNewChatModal);
            document.getElementById('close-modal-btn').addEventListener('click', hideNewChatModal);
            document.getElementById('close-group-code-btn').addEventListener('click', hideGroupCodeModal);

            // تبويبات النافذة المنبثقة
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // إزالة النشاط من جميع التبويبات
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    // إضافة النشاط للتبويب المحدد
                    this.classList.add('active');
                    
                    // إخفاء جميع محتويات التبويبات
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // إظهار محتوى التبويب المحدد
                    const tabId = this.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // بدء المحادثات
            document.getElementById('start-direct-chat').addEventListener('click', startDirectChat);
            document.getElementById('create-group-chat').addEventListener('click', createGroupChat);
            document.getElementById('join-group-chat').addEventListener('click', joinGroupChat);
            document.getElementById('copy-group-code').addEventListener('click', copyGroupCode);

            // إرسال الرسائل
            document.getElementById('send-message-btn').addEventListener('click', sendMessage);
            document.getElementById('message-text').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // عناصر التحكم بالمكالمة
            document.getElementById('start-call-btn').addEventListener('click', startCall);
            document.getElementById('end-call-btn').addEventListener('click', endCall);
        }

        // توليد معرف مستخدم عشوائي مكون من 4 خانات
        function generateUserId() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        // توليد رمز محادثة جماعية عشوائي مكون من 6 خانات
        function generateGroupCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // عرض نافذة المحادثة الجديدة
        function showNewChatModal() {
            document.getElementById('new-chat-modal').style.display = 'flex';
        }

        // إخفاء نافذة المحادثة الجديدة
        function hideNewChatModal() {
            document.getElementById('new-chat-modal').style.display = 'none';
        }

        // عرض نافذة رمز المحادثة الجماعية
        function showGroupCodeModal(code) {
            document.getElementById('group-code-display').textContent = code;
            document.getElementById('group-code-modal').style.display = 'flex';
        }

        // إخفاء نافذة رمز المحادثة الجماعية
        function hideGroupCodeModal() {
            document.getElementById('group-code-modal').style.display = 'none';
        }

        // بدء محادثة مباشرة
        function startDirectChat() {
            const userId = document.getElementById('direct-user-id').value.trim();
            
            if (userId.length !== 4) {
                showNotification('يجب أن يكون المعرف مكون من 4 خانات');
                return;
            }
            
            if (userId === currentUser.id) {
                showNotification('لا يمكن بدء محادثة مع نفسك');
                return;
            }
            
            // التحقق من وجود محادثة مع هذا المستخدم مسبقًا
            const existingChat = chats.find(chat => 
                chat.type === 'direct' && 
                chat.participants.includes(userId)
            );
            
            if (existingChat) {
                switchToChat(existingChat.id);
                hideNewChatModal();
                return;
            }
            
            // إنشاء محادثة جديدة
            const chatId = 'chat_' + Date.now();
            const newChat = {
                id: chatId,
                type: 'direct',
                participants: [currentUser.id, userId],
                messages: [],
                title: `محادثة مع ${userId}`
            };
            
            chats.push(newChat);
            saveChats();
            renderChatList();
            switchToChat(chatId);
            hideNewChatModal();
            
            document.getElementById('direct-user-id').value = '';
        }

        // إنشاء محادثة جماعية
        function createGroupChat() {
            const groupCode = generateGroupCode();
            const chatId = 'group_' + Date.now();
            
            const newChat = {
                id: chatId,
                type: 'group',
                code: groupCode,
                participants: [currentUser.id],
                messages: [],
                title: `المحادثة الجماعية ${groupCode}`
            };
            
            chats.push(newChat);
            saveChats();
            renderChatList();
            switchToChat(chatId);
            hideNewChatModal();
            showGroupCodeModal(groupCode);
        }

        // الانضمام لمحادثة جماعية
        function joinGroupChat() {
            const groupCode = document.getElementById('group-code').value.trim().toUpperCase();
            
            if (groupCode.length !== 6) {
                showNotification('يجب أن يكون الرمز مكون من 6 خانات');
                return;
            }
            
            // البحث عن المحادثة بالرمز
            const existingChat = chats.find(chat => 
                chat.type === 'group' && 
                chat.code === groupCode
            );
            
            if (!existingChat) {
                showNotification('لم يتم العثور على محادثة بهذا الرمز');
                return;
            }
            
            // التحقق إذا كان المستخدم مشاركًا بالفعل
            if (existingChat.participants.includes(currentUser.id)) {
                switchToChat(existingChat.id);
                hideNewChatModal();
                return;
            }
            
            // إضافة المستخدم للمحادثة
            existingChat.participants.push(currentUser.id);
            saveChats();
            renderChatList();
            switchToChat(existingChat.id);
            hideNewChatModal();
            
            document.getElementById('group-code').value = '';
        }

        // نسخ رمز المحادثة الجماعية
        function copyGroupCode() {
            const code = document.getElementById('group-code-display').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showNotification('تم نسخ الرمز');
            });
        }

        // تحميل المحادثات من التخزين
        function loadChats() {
            const savedChats = sessionStorage.getItem('hideChatChats');
            if (savedChats) {
                chats = JSON.parse(savedChats);
                renderChatList();
            }
        }

        // حفظ المحادثات في التخزين
        function saveChats() {
            sessionStorage.setItem('hideChatChats', JSON.stringify(chats));
        }

        // عرض قائمة المحادثات
        function renderChatList() {
            const chatList = document.getElementById('chat-list');
            chatList.innerHTML = '';
            
            if (chats.length === 0) {
                chatList.innerHTML = '<li style="text-align: center; opacity: 0.7; padding: 20px;">لا توجد محادثات</li>';
                return;
            }
            
            chats.forEach(chat => {
                const lastMessage = chat.messages.length > 0 
                    ? chat.messages[chat.messages.length - 1] 
                    : { text: 'لا توجد رسائل بعد', sender: '' };
                
                const chatItem = document.createElement('li');
                chatItem.className = 'chat-item';
                if (currentChat && currentChat.id === chat.id) {
                    chatItem.classList.add('active');
                }
                
                chatItem.innerHTML = `
                    <div class="chat-name">${chat.title}</div>
                    <div class="chat-preview">${lastMessage.sender ? `${lastMessage.sender}: ` : ''}${lastMessage.text}</div>
                `;
                
                chatItem.addEventListener('click', () => switchToChat(chat.id));
                chatList.appendChild(chatItem);
            });
        }

        // التبديل إلى محادثة محددة
        function switchToChat(chatId) {
            currentChat = chats.find(chat => chat.id === chatId);
            if (!currentChat) return;
            
            // تحديث واجهة المحادثة
            document.getElementById('current-chat-title').textContent = currentChat.title;
            document.getElementById('message-input').style.display = 'flex';
            document.getElementById('messages-container').innerHTML = '';
            
            // عرض عناصر التحكم بالمكالمة للمحادثات المباشرة فقط
            if (currentChat.type === 'direct') {
                document.getElementById('call-controls').style.display = 'flex';
            } else {
                document.getElementById('call-controls').style.display = 'none';
            }
            
            // عرض الرسائل
            renderMessages();
            
            // تحديث قائمة المحادثات
            renderChatList();
        }

        // عرض الرسائل في المحادثة الحالية
        function renderMessages() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            if (!currentChat || currentChat.messages.length === 0) {
                messagesContainer.innerHTML = '<div class="welcome-message" style="text-align: center; padding: 40px 20px; opacity: 0.7;"><p>لا توجد رسائل بعد. ابدأ المحادثة الآن!</p></div>';
                return;
            }
            
            currentChat.messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender === currentUser.id ? 'sent' : 'received'}`;
                
                const messageInfo = document.createElement('div');
                messageInfo.className = 'message-info';
                messageInfo.textContent = `${message.sender === currentUser.id ? 'أنت' : message.sender} - ${formatTime(message.timestamp)}`;
                
                messageDiv.textContent = message.text;
                messageDiv.appendChild(messageInfo);
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // التمرير لأسفل لرؤية أحدث الرسائل
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // إرسال رسالة
        function sendMessage() {
            const messageText = document.getElementById('message-text').value.trim();
            if (!messageText || !currentChat) return;
            
            const newMessage = {
                id: 'msg_' + Date.now(),
                text: messageText,
                sender: currentUser.id,
                timestamp: new Date().toISOString()
            };
            
            currentChat.messages.push(newMessage);
            saveChats();
            renderMessages();
            renderChatList();
            
            // مسح حقل الإدخال
            document.getElementById('message-text').value = '';
        }

        // تنسيق الوقت
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        }

        // بدء مكالمة صوتية
        async function startCall() {
            if (!currentChat || currentChat.type !== 'direct') return;
            
            try {
                // الحصول على صلاحيات الميكروفون
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // إنشاء اتصال WebRTC (هذا مثال مبسط)
                // في تطبيق حقيقي، ستحتاج إلى إعداد إشارة بين المستخدمين
                
                showNotification('بدء المكالمة... (هذه ميزة تجريبية)');
                document.getElementById('start-call-btn').style.display = 'none';
                document.getElementById('end-call-btn').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Error starting call:', error);
                showNotification('فشل في بدء المكالمة');
            }
        }

        // إنهاء المكالمة الصوتية
        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            showNotification('تم إنهاء المكالمة');
            document.getElementById('start-call-btn').style.display = 'inline-block';
            document.getElementById('end-call-btn').style.display = 'none';
        }

        // عرض الإشعارات
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>